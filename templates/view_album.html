{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}
{% block body_class %}album-inner-page{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  body.album-inner-page { background: none !important; }

  /* 全屏虚化背景 */
  body.album-inner-page::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image: url('{{ https://res.cloudinary.com/dpr0pl2tf/image/upload/v1756400863/pexels-arts-1124960_itvbiw.jpg") }}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(6px) brightness(0.82);
    z-index: -2;
    pointer-events: none;
  }

  .album-bg-fallback {
    position: fixed;
    inset: 0;
    background-image: url('{{ background_url | default(\'https://res.cloudinary.com/dpr0pl2tf/image/upload/v1754343393/pexels-caio-69969_aq5kzz.jpg\') }}');
    background-position: center;
    filter: blur(6px) brightness(0.82);
    z-index: -3;
    pointer-events: none;
  }

  header, nav, .site-header, .navbar, .main-nav, .topbar {
    position: relative !important;
    z-index: 50 !important;
  }

  .album-content {
    position: relative;
    z-index: 5;
    width: 100%;
    margin: 0 auto;
    padding: 24px 30px;
    box-sizing: border-box;
  }

  .page-title {
    text-align: center;
    margin: 30px 0 20px;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 1px;
    color: #ffffff;
    text-shadow: 0 2px 6px rgba(0,0,0,0.6);
  }

  /* ===== 横向滚动行 ===== */
  .h-row-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .h-viewport {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 12px 0;
  }
  .h-card {
    flex: 0 0 auto;
    width: 200px;
    height: 140px;
    border-radius: 12px;
    overflow: hidden;
    scroll-snap-align: start;
    background: #fff;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    position: relative;
    transition: transform .28s ease, box-shadow .28s ease;
  }
  .h-card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 14px 30px rgba(0,0,0,0.14);
  }
  .h-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform .35s ease;
  }
  .h-card:hover img { transform: scale(1.03); }

  .mag-check {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 12;
    width: 18px; height: 18px;
    accent-color: #007bff;
  }

  .h-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px; height: 48px;
    border-radius: 10px;
    border: none;
    background: rgba(0,0,0,0.45);
    color: #fff;
    font-size: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    cursor: pointer;
    backdrop-filter: blur(6px);
  }
  .h-nav:hover { transform: translateY(-50%) scale(1.04); background: rgba(0,0,0,0.6); }
  .h-prev { left: 12px; }
  .h-next { right: 12px; }

  /* 响应式 */
  @media (max-width: 900px) { .h-card { width: 160px; height: 120px; } .h-nav { display:none; } }
  @media (max-width: 480px) { .h-card { width: 120px; height: 90px; } }
</style>

<div class="album-bg-fallback" aria-hidden="true"></div>

<div class="album-content">
  <h1 class="page-title">{{ album_name }} Album</h1>

  {% if logged_in %}
  <form method="POST" action="{{ url_for('delete_images') }}" onsubmit="return confirm('Are you sure to delete selected images?');">
  {% endif %}

  {% if images|length == 0 %}
    <div style="text-align:center; color:#fff; opacity:.9; margin-top:60px;">This album has no images.</div>
  {% else %}
    {% set row_size = 10 %}
    {% for i in range(0, images|length, row_size) %}
      {% set row_imgs = images[i:i+row_size] %}
      <div class="h-row-container">
        <button class="h-nav h-prev" aria-label="Scroll left">‹</button>
        <div class="h-viewport">
          {% for img in row_imgs %}
          <div class="h-card">
            {% if logged_in %}
              <input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">
            {% endif %}
            <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
              <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
            </a>
          </div>
          {% endfor %}
        </div>
        <button class="h-nav h-next" aria-label="Scroll right">›</button>
      </div>
    {% endfor %}
  {% endif %}

  {% if logged_in %}
    <input type="hidden" name="album_name" value="{{ album_name }}">
    <div style="text-align:right; margin: 10px 0 40px;">
      <button type="submit" style="padding: 8px 14px; border-radius:6px; background:#d9534f; color:#fff; border:none;">
        Delete Selected Images
      </button>
    </div>
  {% endif %}
</div>

<script>
  const lightbox = GLightbox({
    selector: '.glightbox',
    loop: true,
    touchNavigation: true,
    keyboardNavigation: true,
    closeOnOutsideClick: true
  });

  document.querySelectorAll('.h-row-container').forEach(container=>{
    const viewport = container.querySelector('.h-viewport');
    const prev = container.querySelector('.h-prev');
    const next = container.querySelector('.h-next');
    const scrollAmount = viewport.clientWidth * 0.8;

    prev.addEventListener('click', ()=>{ viewport.scrollBy({ left:-scrollAmount, behavior:'smooth' }); });
    next.addEventListener('click', ()=>{ viewport.scrollBy({ left:scrollAmount, behavior:'smooth' }); });

    viewport.addEventListener('wheel', e=>{
      if(Math.abs(e.deltaY) > Math.abs(e.deltaX) && !e.shiftKey){
        e.preventDefault();
        viewport.scrollLeft += e.deltaY;
      }
    }, { passive:false });
  });
</script>

{% endblock %}
