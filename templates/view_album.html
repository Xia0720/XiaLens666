{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<!-- 背景图（统一设置，不依赖相册图片） -->
<div class="album-bg"></div>

<h1 style="text-align:center; margin-top:20px; color:#fff; text-shadow:2px 2px 6px rgba(0,0,0,0.6);">
  {{ album_name }} Album
</h1>

{% if logged_in %}
<form method="POST" action="{{ url_for('delete_images') }}" 
      onsubmit="return confirm('Are you sure to delete selected images?');">
{% endif %}

<style>
/* ===== 背景图 ===== */
.album-bg {
  position: fixed;
  inset: 0;
  background: url("https://res.cloudinary.com/dpr0pl2tf/image/upload/v1754343393/pexels-caio-69969_aq5kzz.jpg")
              no-repeat center center / cover;
  filter: blur(14px) brightness(0.6);
  z-index: -1;
}

/* ===== 杂志风布局基础变量 ===== */
:root{
  --gap: 12px;
  --card-radius: 10px;
  --shadow: 0 8px 20px rgba(0,0,0,0.12);
  --hover-shadow: 0 14px 32px rgba(0,0,0,0.18);
  --max-width: 1400px;
}

/* 容器 */
.magazine {
  max-width: var(--max-width);
  margin: 28px auto;
  padding: 0 14px;
  display: flex;
  flex-direction: column;
  gap: 22px;
}

/* 卡片样式 */
.mag-card {
  overflow: hidden;
  border-radius: var(--card-radius);
  background: #fff;
  box-shadow: var(--shadow);
  transition: transform .28s ease, box-shadow .28s ease;
  position: relative;
}
.mag-card:hover {
  transform: translateY(-6px) scale(1.01);
  box-shadow: var(--hover-shadow);
}
.mag-card img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: inherit;
  transition: transform .3s ease;
}
.mag-card:hover img { transform: scale(1.04); }

/* 管理员勾选框 */
.mag-check {
  position: absolute;
  top: 10px; left: 10px;
  width: 18px; height: 18px;
  z-index: 5;
  accent-color: #007bff;
}

/* ===== 布局行 ===== */
.row-1 {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: var(--gap);
}
.row-1 .big img { aspect-ratio: 16/9; }
.row-1 .side {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}
.row-1 .side .mag-card img { aspect-ratio: 3/4; }

.row-2 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--gap);
}
.row-2 .mag-card { height: 260px; }

.row-3 .mag-card { height: 420px; }
.row-3 .mag-card img { aspect-ratio: 21/8; }

.row-4 {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--gap);
}
.row-4 .mag-card { height: 220px; }

.more-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: var(--gap);
}
.more-grid .mag-card { height: 200px; }

/* ===== 响应式 ===== */
@media (max-width: 1100px) {
  .row-1 { grid-template-columns: 1.6fr 1fr; }
  .row-2 .mag-card { height: 220px; }
  .row-3 .mag-card { height: 320px; }
  .row-4 .mag-card { height: 180px; }
}
@media (max-width: 800px) {
  .row-1 { grid-template-columns: 1fr; }
  .row-1 .side { flex-direction: row; }
  .row-2 { grid-template-columns: repeat(2, 1fr); }
  .row-3 .mag-card { height: 240px; }
  .row-4 { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 480px) {
  .row-2, .row-4 { grid-template-columns: 1fr; }
  .more-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
}
</style>

{# ===== 按行切片（自动适配图片数量） ===== #}
{% set r1 = images[0:3] %}
{% set r2 = images[3:6] %}
{% set r3 = images[6:7] %}
{% set r4 = images[7:11] %}
{% set rest = images[11:] %}

<div class="magazine">

  {# 第一行：大图 + 两小图 #}
  {% if r1 %}
  <div class="row-1">
    <div class="big">
      {% if r1[0] %}
      <div class="mag-card">
        {% if logged_in %}<input class="mag-check" type="checkbox" name="public_ids" value="{{ r1[0].public_id }}">{% endif %}
        <a href="{{ r1[0].secure_url }}" class="glightbox" data-gallery="album">
          <img src="{{ r1[0].secure_url }}" alt="Photo" loading="lazy">
        </a>
      </div>
      {% endif %}
    </div>
    <div class="side">
      {% for img in r1[1:] %}
      <div class="mag-card">
        {% if logged_in %}<input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">{% endif %}
        <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album">
          <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# 第二行：三图横排 #}
  {% if r2 %}
  <div class="row-2">
    {% for img in r2 %}
    <div class="mag-card">
      {% if logged_in %}<input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">{% endif %}
      <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album">
        <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# 第三行：一张超宽图 #}
  {% if r3 %}
  <div class="row-3">
    <div class="mag-card">
      {% if logged_in %}<input class="mag-check" type="checkbox" name="public_ids" value="{{ r3[0].public_id }}">{% endif %}
      <a href="{{ r3[0].secure_url }}" class="glightbox" data-gallery="album">
        <img src="{{ r3[0].secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
  </div>
  {% endif %}

  {# 第四行：四宫格 #}
  {% if r4 %}
  <div class="row-4">
    {% for img in r4 %}
    <div class="mag-card">
      {% if logged_in %}<input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">{% endif %}
      <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album">
        <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# 其余：响应式网格 #}
  {% if rest %}
  <div class="more-grid">
    {% for img in rest %}
    <div class="mag-card">
      {% if logged_in %}<input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">{% endif %}
      <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album">
        <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div>

{% if logged_in %}
  <input type="hidden" name="album_name" value="{{ album_name }}">
  <div style="text-align: right; margin: 20px;">
    <button type="submit" style="padding: 8px 14px; border-radius:6px; background:#d9534f; color:#fff; border:none;">
      Delete Selected Images
    </button>
  </div>
</form>
{% endif %}

<script>
  const lightbox = GLightbox({
    selector: '.glightbox',
    loop: true
  });
</script>
{% endblock %}
