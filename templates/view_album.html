{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}
{% block body_class %}album-page{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

{% set bg_url = background_url if background_url else "https://res.cloudinary.com/dpr0pl2tf/image/upload/v1754343393/pexels-caio-69969_aq5kzz.jpg" %}

<style>
html, body { height: 100%; margin: 0; padding: 0; }
body.album-page { background: none !important; }

/* ===== 全屏虚化背景 ===== */
body.album-page::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('{{ bg_url }}');
  background-size: cover;
  background-position: center;
  filter: blur(6px) brightness(0.82);
  z-index: -2;
  pointer-events: none;
}

.album-bg-fallback {
  position: fixed;
  inset: 0;
  background-image: url('{{ bg_url }}');
  background-size: cover;
  background-position: center;
  filter: blur(5px) brightness(0.92);
  z-index: -3;
  pointer-events: none;
}

.album-header {
  text-align: center;
  margin: 30px 0 20px;
  font-size: 2rem;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.6);
  z-index: 5;
  position: relative;
}

.album-row {
  display: flex;
  overflow-x: auto;
  gap: 12px;
  padding: 12px 0;
  scroll-snap-type: x mandatory;
}
.album-row::-webkit-scrollbar { height: 10px; }
.album-row::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.3); border-radius: 5px; }

.album-card {
  flex: 0 0 auto;
  width: 160px;
  height: 160px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  scroll-snap-align: start;
  position: relative;
  transition: transform .28s ease, box-shadow .28s ease;
}
.album-card:hover {
  transform: scale(1.03);
  box-shadow: 0 12px 26px rgba(0,0,0,0.12);
}
.album-card img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform .32s ease, filter .32s ease;
}
.album-card:hover img {
  transform: scale(1.05);
  filter: brightness(1.03);
}

/* 管理员 checkbox */
.album-check {
  position: absolute;
  top: 8px;
  left: 8px;
  width: 18px;
  height: 18px;
  z-index: 12;
  accent-color: #007bff;
}

@media (max-width: 768px) {
  .album-card { width: 120px; height: 120px; }
}
@media (max-width: 480px) {
  .album-card { width: 100px; height: 100px; }
}
</style>

<div class="album-bg-fallback" aria-hidden="true"></div>

<div class="album-content">
  <div class="album-header">{{ album_name }}</div>

  {% if logged_in %}
  <form method="POST" action="{{ url_for('delete_images') }}" onsubmit="return confirm('Are you sure to delete selected images?');">
  {% endif %}

  {# 将图片分批，每行最多10张 #}
  {% set batch_size = 10 %}
  {% for i in range(0, images|length, batch_size) %}
    <div class="album-row">
      {% for img in images[i:i+batch_size] %}
        <div class="album-card">
          {% if logged_in %}
          <input type="checkbox" class="album-check" name="public_ids" value="{{ img.public_id }}">
          {% endif %}
          <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
            <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
          </a>
        </div>
      {% endfor %}
    </div>
  {% endfor %}

  {% if logged_in %}
    <input type="hidden" name="album_name" value="{{ album_name }}">
    <div style="text-align: right; margin: 12px 0 40px;">
      <button type="submit" style="padding: 8px 14px; border-radius:6px; background:#d9534f; color:#fff; border:none;">
        Delete Selected Images
      </button>
    </div>
  </form>
  {% endif %}
</div>

<script>
const lightbox = GLightbox({
  selector: '.glightbox',
  loop: true,
  touchNavigation: true,
  keyboardNavigation: true,
  closeOnOutsideClick: true
});
</script>

{% endblock %}
