{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

{# 选择背景：若有图片用第一张，否则用回退图 #}
{% set bg = images[0].secure_url if images|length > 0 else 'https://res.cloudinary.com/dpr0pl2tf/image/upload/v1756396039/pexels-pixabay-289618_iyg9c4.jpg' %}
{% set fallback_bg = 'https://res.cloudinary.com/dpr0pl2tf/image/upload/v1754343393/pexels-caio-69969_aq5kzz.jpg' %}

<style>
  /* 基础 - 保证页面可铺满并且背景虚化（和 album.html 风格一致） */
  html, body { height: 100%; margin: 0; padding: 0; }
  body.album-page { background: none !important; }

  body.album-page::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image: url('{{ bg }}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(8px) brightness(0.86);
    z-index: -2;
    pointer-events: none;
  }

  .album-bg-fallback {
    position: fixed;
    inset: 0;
    background-image: url('{{ fallback_bg }}');
    background-size: cover;
    background-position: center;
    filter: blur(10px) brightness(0.78);
    z-index: -3;
    pointer-events: none;
  }

  header, nav, .site-header, .navbar, .main-nav, .topbar {
    position: relative !important;
    z-index: 60 !important;
  }

  /* ===========================
     核心修改：让内容不被“中间容器”限制
     =========================== */

  /* 1) .magazine 取消 max-width / 居中，强制全文宽（覆盖可能来自 base.html 的 container 规则） */
  .magazine {
    max-width: none !important;   /* 关键：移除宽度上限 */
    width: 100% !important;       /* 占满可用宽度 */
    margin: 0 !important;         /* 取消自动居中空白 */
    padding: 18px 20px !important;/* 适度内边距，避免贴边过紧 */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 22px;
  }

  /* 2) 如果你想让某些“行”真正贴满视口左右（edge-to-edge），可以用 .edge-row。
     它会超出父容器，延伸到视口边缘（可选）。*/
  .edge-row {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    padding: 0 12px; /* 保留一点内边距 */
    box-sizing: border-box;
  }

  /* 保留你的卡片样式，但去掉会造成裁切的 overflow（保证图片自由排列） */
  .mag-card {
    overflow: visible;               /* 允许子元素自由展示，不被裁切 */
    border-radius: 10px;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 8px 20px rgba(0,0,0,0.10);
    transition: transform .28s, box-shadow .28s;
    position: relative;
  }
  .mag-card:hover { transform: translateY(-6px) scale(1.003); box-shadow: 0 14px 30px rgba(0,0,0,0.14); }

  .mag-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 8px;
  }

  /* 管理复选框 */
  .mag-check { position: absolute; top: 10px; left: 10px; z-index: 12; width: 18px; height: 18px; }

  /* 行与网格（保留你原有的布局逻辑，只把宽度逻辑改为相对于可用宽度） */
  .row-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; align-items: stretch; }
  .row-1 .big .mag-card { height: 100%; }
  .row-1 .big img { aspect-ratio: 16/9; }
  .row-1 .side { display:flex; flex-direction:column; gap:12px; }
  .row-1 .side .mag-card { height: 100%; flex: 1 1 0; }
  .row-1 .side .mag-card img { aspect-ratio: 3/4; }

  .row-2 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
  .row-2 .mag-card { height: 260px; }

  .row-3 .mag-card { height: 420px; }
  .row-3 .mag-card img { aspect-ratio: 21/8; }

  .row-4 { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
  .row-4 .mag-card { height: 220px; }

  .more-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
  .more-grid .mag-card { height: 200px; }

  /* 响应式：小屏时改成单列或少列 */
  @media (max-width: 1100px) {
    .row-1 { grid-template-columns: 1.6fr 1fr; }
    .row-2 .mag-card { height: 220px; }
    .row-3 .mag-card { height: 320px; }
    .row-4 .mag-card { height: 180px; }
  }
  @media (max-width: 900px) {
    .row-1 { grid-template-columns: 1fr; }
    .row-1 .side { flex-direction: row; }
    .row-1 .side .mag-card img { aspect-ratio: 4/3; }
    .row-1 .big img { aspect-ratio: 3/2; }
    .row-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .row-3 .mag-card { height: 240px; }
    .row-4 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .more-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
  }
  @media (max-width: 480px) {
    .row-2 { grid-template-columns: 1fr; }
    .row-4 { grid-template-columns: 1fr; }
    .magazine { padding: 12px; gap: 16px; }
  }
</style>

{# 背景回退层 #}
<div class="album-bg-fallback" aria-hidden="true"></div>

{# 把 body 加上 album-page class（与 album.html 保持一致） #}
<script>
  (function(){
    try {
      if (!document.body.classList.contains('album-page')) {
        document.body.classList.add('album-page');
      }
    } catch (e) {
      document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('album-page'); });
    }
  })();
</script>

<h1 style="text-align:center; margin-top:20px;">{{ album_name }} Album</h1>

{% if logged_in %}
<form method="POST" action="{{ url_for('delete_images') }}" onsubmit="return confirm('Are you sure to delete selected images?');">
{% endif %}

{# ========== 把 images 按行切片（兼容图片少的情况） ========== #}
{% set r1 = images[0:3] %}
{% set r2 = images[3:6] %}
{% set r3 = images[6:7] %}
{% set r4 = images[7:11] %}
{% set rest = images[11:] %}

<div class="magazine">

  {# 第一行：大图 + 右侧两竖图 #}
  {% if r1|length > 0 %}
  <div class="row-1">
    <div class="big">
      {% if r1[0] %}
      <div class="mag-card">
        {% if logged_in %}
          <input class="mag-check" type="checkbox" name="public_ids" value="{{ r1[0].public_id }}">
        {% endif %}
        <a href="{{ r1[0].secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
          <img src="{{ r1[0].secure_url }}" alt="Photo" loading="lazy">
        </a>
      </div>
      {% endif %}
    </div>

    <div class="side">
      {% if r1|length > 1 %}
      <div class="mag-card">
        {% if logged_in %}
          <input class="mag-check" type="checkbox" name="public_ids" value="{{ r1[1].public_id }}">
        {% endif %}
        <a href="{{ r1[1].secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
          <img src="{{ r1[1].secure_url }}" alt="Photo" loading="lazy">
        </a>
      </div>
      {% endif %}
      {% if r1|length > 2 %}
      <div class="mag-card">
        {% if logged_in %}
          <input class="mag-check" type="checkbox" name="public_ids" value="{{ r1[2].public_id }}">
        {% endif %}
        <a href="{{ r1[2].secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
          <img src="{{ r1[2].secure_url }}" alt="Photo" loading="lazy">
        </a>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {# 第二行：三张横向并列 #}
  {% if r2|length > 0 %}
  <div class="row-2">
    {% for img in r2 %}
    <div class="mag-card">
      {% if logged_in %}
        <input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">
      {% endif %}
      <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
        <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# 第三行：一张超宽横图 #}
  {% if r3|length > 0 %}
  <div class="row-3">
    <div class="mag-card">
      {% if logged_in %}
        <input class="mag-check" type="checkbox" name="public_ids" value="{{ r3[0].public_id }}">
      {% endif %}
      <a href="{{ r3[0].secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
        <img src="{{ r3[0].secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
  </div>
  {% endif %}

  {# 第四行：四宫格 #}
  {% if r4|length > 0 %}
  <div class="row-4">
    {% for img in r4 %}
    <div class="mag-card">
      {% if logged_in %}
        <input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">
      {% endif %}
      <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
        <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# 其余图片：紧凑响应式小网格（自动填充） #}
  {% if rest|length > 0 %}
  <div class="more-grid">
    {% for img in rest %}
    <div class="mag-card">
      {% if logged_in %}
        <input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">
      {% endif %}
      <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
        <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
      </a>
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div> {# .magazine end #}

{% if logged_in %}
  <input type="hidden" name="album_name" value="{{ album_name }}">
  <div style="text-align: right; margin: 10px 18px 40px 18px;">
    <button type="submit" style="padding: 8px 14px; border-radius:6px; background:#d9534f; color:#fff; border:none;">
      Delete Selected Images
    </button>
  </div>
</form>
{% endif %}

<script>
  const lightbox = GLightbox({
    selector: '.glightbox',
    loop: true,
    touchNavigation: true,
    keyboardNavigation: true,
    closeOnOutsideClick: true
  });
</script>
{% endblock %}
