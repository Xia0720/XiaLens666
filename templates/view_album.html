{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}
{% block body_class %}album-page{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<style>
html, body { height: 100%; margin: 0; padding: 0; }

/* 移除渐变背景，完全交给虚化背景 */
html, body { background: none !important; }

/* ========== 全屏虚化背景 ========== */
body.album-page::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('{{ background_url if background_url else "/static/default_bg.jpg" }}');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  filter: blur(8px) brightness(0.85);
  z-index: -2;
  pointer-events: none;
}

.album-bg-fallback {
  position: fixed;
  inset: 0;
  background-image: url('{{ background_fallback_url if background_fallback_url else "/static/default_bg.jpg" }}');
  background-size: cover;
  background-position: center;
  filter: blur(8px) brightness(0.82);
  z-index: -3;
  pointer-events: none;
}

/* ---------- 内容容器 ---------- */
.album-content {
  position: relative;
  z-index: 5;
  width: 100%;
  padding: 40px 20px;
  box-sizing: border-box;
  min-height: 100vh;
}

/* 页面标题 */
.album-content h1 {
  text-align: center;
  font-size: 1.8rem;
  color: #000;
  font-weight: 900;
  text-shadow: 
    -1px -1px 0 #fff,
     1px -1px 0 #fff,
    -1px  1px 0 #fff,
     1px  1px 0 #fff,
     0  2px 5px rgba(0,0,0,0.5);
  margin-bottom: 8px;
}

/* Drive CTA */
.drive-cta {
  display:inline-block;
  margin: 8px auto 28px;
  text-decoration: none;
  background:#f1f8ff;
  border:1px solid #cfe6ff;
  color:#174ea6;
  padding:8px 12px;
  border-radius:8px;
  font-weight:600;
}

/* ---------- 横向滚动行 ---------- */
.album-row {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding: 0 20px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 36px;
  justify-content: start;
}

/* 滚动条渐变美化 */
.album-row::-webkit-scrollbar { height: 12px; }
.album-row::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
}
.album-row::-webkit-scrollbar-thumb {
  border-radius: 6px;
  background: linear-gradient(90deg, #434343, #000000, #ffd700);
}
.album-row::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(90deg, #ffd700, #000000, #434343);
}

/* ---------- 单张图片 ---------- */
.album-item {
  flex: 0 0 auto;
  width: 260px;
  height: 200px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  position: relative;
  scroll-snap-align: center;
  background: rgba(255,255,255,0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.album-item:hover {
  transform: scale(1.06);
  box-shadow: 0 12px 28px rgba(0,0,0,0.2);
}

.album-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* 管理员 checkbox */
.album-item input[type="checkbox"] {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
  width: 20px;
  height: 20px;
  accent-color: #007bff;
}

/* 响应式调整 */
@media (max-width: 1024px) { .album-item { width: 260px; height: 200px; } }
@media (max-width: 768px)  { .album-item { width: 200px; height: 150px; } }
@media (max-width: 480px)  { .album-item { width: 140px; height: 110px; } }

.empty-note {
  text-align:center;
  color:#666;
  padding:36px 12px;
  background:#fffdf7;
  border-radius:8px;
  margin-top:18px;
}
</style>

<div class="album-bg-fallback" aria-hidden="true"></div>

<div class="album-content">
  <h1>{{ album_name }} Album</h1>

  <!-- Google Drive 旧照片入口（如果后端传入 drive_link） -->
  {% if drive_link %}
    <div style="text-align:center;">
      <a class="drive-cta" href="{{ drive_link }}" target="_blank" rel="noopener">
        查看旧照片（Google Drive）
      </a>
    </div>
  {% endif %}

  {% if logged_in %}
  <form method="POST" action="{{ url_for('delete_images') }}" onsubmit="return confirm('Are you sure to delete selected images?');">
  {% endif %}

  {% set row_size = 10 %}
  {% if images and images|length > 0 %}
    {% for i in range(0, images|length, row_size) %}
      <div class="album-row">
        {% for img in images[i:i+row_size] %}
        <div class="album-item">
          {% if logged_in %}
            <!-- 这里 value 用 public_id 或 URL，两种都兼容后端删图逻辑 -->
            <input type="checkbox" name="public_ids" value="{{ img.public_id or img.secure_url }}">
          {% endif %}
          <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
            <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
          </a>
        </div>
        {% endfor %}
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-note">
      这个相册中还没有（新的）照片可以显示。
      {% if drive_link %}
        <div style="margin-top:10px;">
          旧照片可通过 <a href="{{ drive_link }}" target="_blank">Google Drive（旧照片）</a> 查看。
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if logged_in %}
    <input type="hidden" name="album_name" value="{{ album_name }}">
    <div style="text-align: right; margin: 20px 18px 40px 18px;">
      <button type="submit" style="padding: 8px 14px; border-radius:6px; background:#d9534f; color:#fff; border:none;">
        Delete Selected Images
      </button>
    </div>
  {% endif %}
  {% if logged_in %}
  </form>
  {% endif %}
</div>

<script>
const lightbox = GLightbox({
  selector: '.glightbox',
  loop: true,
  touchNavigation: true,
  keyboardNavigation: true,
  closeOnOutsideClick: true
});
</script>
{% endblock %}
