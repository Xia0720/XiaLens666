{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}
{% block body_class %}album-page{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<style>
/* === 保留你原来的样式 === */
html, body { height: 100%; margin: 0; padding: 0; }
html, body { background: none !important; }
body.album-page::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('{{ background_url if background_url else "https://res.cloudinary.com/dpr0pl2tf/image/upload/v1756329504/pexels-alex-andrews-271121-1983038_dbwaac.jpg" }}');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  filter: blur(8px) brightness(0.85);
  z-index: -2;
  pointer-events: none;
}
.album-bg-fallback {
  position: fixed;
  inset: 0;
  background-image: url('{{ background_fallback_url if background_fallback_url else "https://res.cloudinary.com/dpr0pl2tf/image/upload/v1756329504/pexels-alex-andrews-271121-1983038_dbwaac.jpg" }}');
  background-size: cover;
  background-position: center;
  filter: blur(8px) brightness(0.82);
  z-index: -3;
  pointer-events: none;
}
.album-content {
  position: relative;
  z-index: 5;
  width: 100%;
  padding: 40px 20px;
  min-height: 100vh;
}
.album-content h1 {
  text-align: center;
  font-size: 1.8rem;
  color: #000;
  font-weight: 900;
  text-shadow: -1px -1px 0 #fff,
               1px -1px 0 #fff,
              -1px  1px 0 #fff,
               1px  1px 0 #fff,
               0  2px 5px rgba(0,0,0,0.5);
  margin-bottom: 36px;
}
.album-row {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding: 0 20px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 36px;
  justify-content: start;
}
.album-row::-webkit-scrollbar { height: 12px; }
.album-row::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
}
.album-row::-webkit-scrollbar-thumb {
  border-radius: 6px;
  background: linear-gradient(90deg, #434343, #000000, #ffd700);
}
.album-row::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(90deg, #ffd700, #000000, #434343);
}
.album-item {
  flex: 0 0 auto;
  width: 260px;
  height: 200px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  position: relative;
  scroll-snap-align: center;
  background: rgba(255,255,255,0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.album-item:hover {
  transform: scale(1.06);
  box-shadow: 0 12px 28px rgba(0,0,0,0.2);
}
.album-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
/* checkbox */
.album-item input[type="checkbox"] {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
  width: 20px;
  height: 20px;
  accent-color: #007bff;
}
/* 按钮区域 */
.action-buttons {
  text-align: right;
  margin: 20px 18px 40px 18px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.action-buttons button {
  padding: 8px 14px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
.delete-btn {
  background: #d9534f;
  color: #fff;
}
.cover-btn {
  background: #007bff;
  color: #fff;
}
</style>

<div class="album-bg-fallback" aria-hidden="true"></div>

<div class="album-content">
  <h1>{{ album_name }} Album</h1>

  {% if logged_in %}
  <!-- 删除图片表单 -->
  <form id="deleteForm" method="POST" action="{{ url_for('delete_images') }}"
        onsubmit="return confirm('Are you sure to delete selected images?');">
  {% endif %}

  {% set row_size = 10 %}
  {% for i in range(0, images|length, row_size) %}
    <div class="album-row">
      {% for img in images[i:i+row_size] %}
      <div class="album-item" data-public-id="{{ img.public_id }}">
        {% if logged_in %}
          <input type="checkbox" name="public_ids" value="{{ img.public_id }}">
        {% endif %}
        <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}">
          <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
        </a>
      </div>
      {% endfor %}
    </div>
  {% endfor %}

  {% if logged_in %}
    <input type="hidden" id="albumId" value="{{ album.id }}">
    <div class="action-buttons">
      <button type="submit" class="delete-btn">Delete Selected Images</button>
      <button type="button" id="setCoverBtn" class="cover-btn">Set as Cover</button>
    </div>
  </form>
  {% endif %}
</div>

<script>
const lightbox = GLightbox({
  selector: '.glightbox',
  loop: true,
  touchNavigation: true,
  keyboardNavigation: true,
  closeOnOutsideClick: true
});

// === 设置封面逻辑 ===
document.getElementById('setCoverBtn')?.addEventListener('click', () => {
  const selected = document.querySelector('input[name="public_ids"]:checked');
  if (!selected) {
    alert("Please select one image to set as cover.");
    return;
  }
  const publicId = selected.value;
  const albumId = document.getElementById("albumId").value;

  fetch(`/set_cover/${albumId}/${encodeURIComponent(publicId)}`, {
    method: "POST"
  }).then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Cover set successfully!");
        location.reload();
      } else {
        alert("Failed to set cover: " + (data.error || "Unknown error"));
      }
    }).catch(err => {
      alert("Failed to set cover: " + err);
    });
});
</script>
{% endblock %}

