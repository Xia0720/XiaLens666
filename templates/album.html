{% extends "base.html" %}
{% block title %}{{ album_name }} - Album{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

{# 固定的相册内页背景图（把这个换成你想要的固定背景图 URL） #}
{% set bg_fixed = 'https://res.cloudinary.com/dpr0pl2tf/image/upload/v1756400863/pexels-arts-1124960_itvbiw.jpg' %}
{% set bg_fallback = 'https://res.cloudinary.com/dpr0pl2tf/image/upload/v1756396039/pexels-pixabay-289618_iyg9c4.jpg' %}

<style>
  /* ---------- 背景 & 基础 ---------- */
  html, body { height: 100%; margin: 0; padding: 0; }
  body.album-page { background: none !important; }

  /* 使用固定图作为虚化背景（不会随图片列表变化） */
  body.album-page::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image: url('{{ bg_fixed }}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(10px) brightness(0.82);
    z-index: -2;
    pointer-events: none;
  }

  /* 更深的回退层（可留作微妙的色调） */
  .album-bg-fallback {
    position: fixed;
    inset: 0;
    background-image: url('{{ bg_fallback }}');
    background-size: cover;
    background-position: center;
    filter: blur(12px) brightness(0.72);
    z-index: -3;
    pointer-events: none;
  }

  header, nav, .site-header, .navbar, .main-nav, .topbar {
    position: relative !important;
    z-index: 60 !important;
  }

  /* ---------- 容器：取消中间 max-width 限制，让内容可以铺满 ---------- */
  .magazine {
    max-width: none !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 18px 18px;
    box-sizing: border-box;
  }

  h1.album-title {
    text-align: center;
    margin-top: 20px;
    color: #222;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.22);
    font-size: 1.9rem;
  }

  /* ========== 横向画廊核心样式 ========== */
  :root {
    --gallery-height: 72vh;    /* 画廊高度（可调整） */
    --gap: 20px;
    --card-radius: 12px;
  }

  .gallery-wrap {
    width: 100%;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    padding: 28px 48px;        /* 左右内边距让首尾不贴边 */
    box-sizing: border-box;
    display: flex;
    gap: var(--gap);
    align-items: center;
  }

  /* 每个横向 slide（保持图片不被容器裁切） */
  .slide {
    flex: 0 0 auto;
    width: clamp(320px, 70vw, 1200px);   /* 在不同屏幕下宽度自适应 */
    height: var(--gallery-height);
    scroll-snap-align: center;
    position: relative;
    overflow: visible;        /* 允许图片微微溢出，保留视觉张力 */
    border-radius: var(--card-radius);
    transition: transform .32s cubic-bezier(.2,.9,.2,1), box-shadow .32s ease;
    will-change: transform;
  }

  /* 图片视觉（cover） */
  .slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: calc(var(--card-radius) - 2px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    transition: transform .32s ease, filter .28s ease;
  }

  /* 鼠标悬停浮动效果（保留你原来的感觉） */
  .slide:hover {
    transform: translateY(-10px) scale(1.01);
    z-index: 8;
  }
  .slide:hover img {
    transform: scale(1.03);
    filter: brightness(1.02);
    box-shadow: 0 24px 50px rgba(0,0,0,0.18);
  }

  /* 管理复选框（登录时可见） */
  .slide .mag-check {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 20;
    width: 18px;
    height: 18px;
  }

  /* caption（可选，鼠标悬停显示） */
  .slide .caption {
    position: absolute;
    left: 0; right: 0; bottom: 0;
    padding: 12px;
    color: #fff;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.56) 100%);
    opacity: 0;
    transform: translateY(6px);
    transition: opacity .28s ease, transform .28s ease;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    pointer-events: none;
  }
  .slide:hover .caption { opacity: 1; transform: translateY(0); }

  /* 左右导航按钮（可点击翻页） */
  .nav-btn {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
    border: none;
    box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 120;
  }
  .nav-btn:hover { transform: translateY(-50%) scale(1.04); }
  .nav-btn.left { left: 12px; }
  .nav-btn.right { right: 12px; }

  .nav-btn svg { width: 18px; height: 18px; fill: #222; }

  /* 隐藏默认滚动条（仍可横向滚） */
  .gallery-wrap::-webkit-scrollbar { height: 10px; }
  .gallery-wrap::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }

  /* 响应式调整：小屏时变高、首尾内边距缩小 */
  @media (max-width: 1000px) {
    :root { --gallery-height: 62vh; }
    .gallery-wrap { padding: 18px 20px; gap: 16px; }
    .slide { width: clamp(260px, 86vw, 900px); }
  }
  @media (max-width: 600px) {
    :root { --gallery-height: 62vh; }
    .gallery-wrap { padding: 12px 12px; gap: 12px; }
    .slide { width: 86vw; height: 60vh; }
    .nav-btn { display: none; } /* 移动端隐藏箭头，靠手势滚动 */
  }

  /* 若没有图片的情况下的空状态 */
  .empty-hint {
    text-align: center;
    color: #fff;
    padding: 60px 18px;
    font-size: 1.05rem;
  }
</style>

{# 背景回退层（保留） #}
<div class="album-bg-fallback" aria-hidden="true"></div>

{# 保持 album-page class（和 album.html 一致） #}
<script>
  (function(){
    try {
      if (!document.body.classList.contains('album-page')) {
        document.body.classList.add('album-page');
      }
    } catch (e) {
      document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('album-page'); });
    }
  })();
</script>

<h1 class="album-title">{{ album_name }} Album</h1>

{# 登入时包裹表单以支持删除选择功能 #}
{% if logged_in %}
<form method="POST" action="{{ url_for('delete_images') }}" onsubmit="return confirm('Are you sure to delete selected images?');">
{% endif %}

  <div class="magazine">
    {% if images|length == 0 %}
      <div class="empty-hint">This album has no photos yet.</div>
    {% else %}
      <div class="gallery-wrap" id="galleryWrap" aria-label="Horizontal photo gallery">
        {% for img in images %}
          <div class="slide" data-index="{{ loop.index0 }}">
            {% if logged_in %}
              <input class="mag-check" type="checkbox" name="public_ids" value="{{ img.public_id }}">
            {% endif %}
            <a href="{{ img.secure_url }}" class="glightbox" data-gallery="album-{{ album_name }}" aria-label="Open photo">
              <img src="{{ img.secure_url }}" alt="Photo" loading="lazy">
            </a>
            <div class="caption">
              <div style="font-weight:600;">{{ img.public_id | default('Photo') }}</div>
            </div>
          </div>
        {% endfor %}
      </div>

      {# 左右箭头（桌面可见） #}
      <button class="nav-btn left" id="prevBtn" aria-label="Previous photo" type="button">
        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
      <button class="nav-btn right" id="nextBtn" aria-label="Next photo" type="button">
        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
      </button>
    {% endif %}
  </div>

{% if logged_in %}
  <input type="hidden" name="album_name" value="{{ album_name }}">
  <div style="text-align: right; margin: 10px 18px 40px 18px;">
    <button type="submit" style="padding: 8px 14px; border-radius:6px; background:#d9534f; color:#fff; border:none;">
      Delete Selected Images
    </button>
  </div>
</form>
{% endif %}

<script>
  /* 初始化 GLightbox（保留原来参数） */
  const lightbox = GLightbox({
    selector: '.glightbox',
    loop: true,
    touchNavigation: true,
    keyboardNavigation: true,
    closeOnOutsideClick: true
  });

  /* 横向滚动控制逻辑 */
  (function(){
    const wrap = document.getElementById('galleryWrap');
    if (!wrap) return;

    const slides = Array.from(wrap.querySelectorAll('.slide'));
    let currentIndex = 0;

    // 把索引为 0 的图片居中显示（平滑）
    function centerIndex(i, smooth=true){
      if (!slides[i]) return;
      slides[i].scrollIntoView({behavior: smooth ? 'smooth' : 'auto', inline: 'center', block: 'nearest'});
      currentIndex = i;
    }

    // 更新 currentIndex：选取最接近容器中心的 slide
    function updateCurrentIndex(){
      const wrapRect = wrap.getBoundingClientRect();
      const centerX = wrapRect.left + wrapRect.width / 2;
      let best = {idx: 0, dist: Infinity};
      slides.forEach((s, idx) => {
        const r = s.getBoundingClientRect();
        const sCenter = r.left + r.width / 2;
        const d = Math.abs(sCenter - centerX);
        if (d < best.dist){ best = {idx, dist: d}; }
      });
      currentIndex = best.idx;
    }

    // arrow handlers
    document.getElementById('prevBtn').addEventListener('click', () => {
      updateCurrentIndex();
      const next = Math.max(0, currentIndex - 1);
      centerIndex(next);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      updateCurrentIndex();
      const next = Math.min(slides.length - 1, currentIndex + 1);
      centerIndex(next);
    });

    // 鼠标滚动或触摸结束后更新 index（节流）
    let scrollTimer = null;
    wrap.addEventListener('scroll', () => {
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(()=> { updateCurrentIndex(); }, 80);
    }, { passive: true });

    // 键盘左右控制（当焦点不在输入框时）
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight'){ document.getElementById('nextBtn').click(); }
      if (e.key === 'ArrowLeft'){ document.getElementById('prevBtn').click(); }
    });

    // 初始居中第一张
    window.addEventListener('load', ()=> centerIndex(0, false));
    // 在窗口尺寸改变时重新居中当前项
    window.addEventListener('resize', ()=> centerIndex(currentIndex, false));
  })();
</script>
{% endblock %}

