{% extends "base.html" %}
{% block content %}
<h2>Upload Media</h2>

<div>
    <label for="albumSelect">选择相册</label><br>
    <select name="album" id="albumSelect" onchange="toggleNewAlbumInput()">
        {% for album in album_names %}
            <option value="{{ album }}">{{ album }}</option>
        {% endfor %}
        <option value="new">+ 创建新相册</option>
    </select>
</div>

<div id="newAlbumDiv" style="display:none; margin-top:10px;">
    <label for="new_album">新相册名</label><br>
    <input type="text" id="new_album" placeholder="输入新相册名">
</div>

<div style="margin-top:15px;">
    <label for="media">选择图片或视频</label><br>
    <input type="file" id="media" accept="image/*,video/*" multiple required>
</div>

<button type="button" onclick="uploadMedia()" style="margin-top:15px;">上传</button>

<div id="uploadStatus" style="margin-top:15px;"></div>

<script>
function toggleNewAlbumInput() {
    var select = document.getElementById('albumSelect');
    var newAlbumDiv = document.getElementById('newAlbumDiv');
    if (select.value === 'new') {
        newAlbumDiv.style.display = 'block';
    } else {
        newAlbumDiv.style.display = 'none';
    }
}

async function uploadMedia() {
    const files = document.getElementById('media').files;
    if (!files.length) {
        alert("请选择文件！");
        return;
    }

    const select = document.getElementById('albumSelect');
    const newAlbumName = document.getElementById('new_album').value.trim();
    let folder = select.value === 'new' && newAlbumName ? newAlbumName : select.value;
    if (!folder) {
        alert("请输入相册名！");
        return;
    }

    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.innerHTML = "上传中...";

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const isVideo = file.type.startsWith("video/");
        const url = `https://api.cloudinary.com/v1_1/dpr0pl2tf/${isVideo ? "video" : "image"}/upload`;
        const preset = isVideo ? "video_upload_preset" : "image_upload_preset";

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", preset);
        formData.append("folder", isVideo ? `video/${folder}` : `album/${folder}`);

        try {
            const response = await fetch(url, {
                method: "POST",
                body: formData
            });
            const data = await response.json();
            if (data.error) {
                console.error(data.error);
                statusDiv.innerHTML += `<br>${file.name} 上传失败: ${data.error.message}`;
            } else {
                statusDiv.innerHTML += `<br>${file.name} 上传成功`;
            }
        } catch (err) {
            console.error(err);
            statusDiv.innerHTML += `<br>${file.name} 上传失败: ${err}`;
        }
    }

    statusDiv.innerHTML += "<br>上传完成！刷新页面查看。";
}
</script>
{% endblock %}

