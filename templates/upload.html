{% extends "base.html" %}
{% block title %}Upload Photos{% endblock %}
{% block content %}
<h2>Upload Photos</h2>

<form id="uploadForm" method="POST" enctype="multipart/form-data">
  <div>
    <label for="albumSelect">选择相册</label><br>
    <select name="album" id="albumSelect" onchange="toggleNewAlbumInput()">
      {% for album in album_names %}
        {% if last_album %}
          <option value="{{ album }}" {% if last_album == album %}selected{% endif %}>{{ album }}</option>
        {% else %}
          <option value="{{ album }}">{{ album }}</option>
        {% endif %}
      {% endfor %}
      <option value="new" {% if last_album and last_album not in album_names %}selected{% endif %}>+ 创建新相册</option>
    </select>
  </div>

  <div id="newAlbumDiv"
       style="display:{% if last_album and last_album not in album_names %}block{% else %}none{% endif %}; margin-top:10px;">
    <label for="new_album">新相册名</label><br>
    <input type="text" name="new_album" id="newAlbumInput"
           placeholder="输入新相册名"
           value="{% if last_album and last_album not in album_names %}{{ last_album }}{% endif %}">
  </div>

  <div style="margin-top:15px;">
    <label for="photo">选择照片</label><br>
    <input type="file" name="photo" id="photo" multiple required>
  </div>

  <button id="submitBtn" type="submit" style="margin-top:15px;">上传</button>
</form>

<div id="uploadStatus" style="margin-top:15px; font-size:14px; color:#444;"></div>

<script>
/*
  前端上传逻辑（改为：直接把每个文件 POST 到后端 /upload）
  - 逐文件上传，单文件 FormData: { photo: file, album: <name> 或 new_album: <name> }
  - 每个文件最多重试 3 次
  - 不依赖 Cloudinary 前端 API；后端负责压缩并保存到 Supabase（或处理 google-drive 链接）
*/

const MAX_ATTEMPTS = 3;

function toggleNewAlbumInput() {
  const select = document.getElementById('albumSelect');
  const newAlbumDiv = document.getElementById('newAlbumDiv');
  newAlbumDiv.style.display = (select && select.value === 'new') ? 'block' : 'none';
}
document.addEventListener('DOMContentLoaded', toggleNewAlbumInput);

document.getElementById('uploadForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const albumSelect = document.getElementById('albumSelect');
  const newAlbumInput = document.getElementById('newAlbumInput');
  const files = document.getElementById('photo').files;
  const statusDiv = document.getElementById('uploadStatus');
  const submitBtn = document.getElementById('submitBtn');

  let album = (albumSelect.value === 'new') ? (newAlbumInput.value || "").trim() : albumSelect.value;
  if (!album) { alert("请填写相册名！"); return; }
  if (!files || files.length === 0) { alert("请选择照片！"); return; }

  submitBtn.disabled = true;
  submitBtn.textContent = "正在上传...";
  statusDiv.innerHTML = "";

  for (const file of Array.from(files)) {
    const item = document.createElement('div');
    item.textContent = `${file.name} - 准备上传...`;
    statusDiv.appendChild(item);

    let success = false;
    let lastError = null;
    for (let attempt = 1; attempt <= MAX_ATTEMPTS && !success; attempt++) {
      try {
        item.textContent = `${file.name} - 上传中（第 ${attempt} 次）...`;
        const formData = new FormData();
        formData.append('photo', file);
        formData.append('album', album);
        if (albumSelect.value === 'new') formData.append('new_album', album);

        const res = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();

        if (!res.ok || data.success === false) {
          throw new Error(data.error || `Upload failed (status ${res.status})`);
        }

        // data.urls 是后端返回的已上传 URL 列表（此处应该对应单文件上传，取第一个）
        const uploadedUrl = (data.urls && data.urls.length) ? data.urls[0] : null;
        item.textContent = `${file.name} ✅ 上传成功`;
        item.style.color = "green";
        success = true;
      } catch (err) {
        console.warn(`Upload attempt ${attempt} failed for ${file.name}:`, err);
        lastError = err;
        if (attempt < MAX_ATTEMPTS) {
          await new Promise(r => setTimeout(r, 400 * attempt));
        } else {
          item.textContent = `${file.name} ❌ 上传失败：${err.message || err}`;
          item.style.color = "red";
        }
      }
    }
  }

  submitBtn.disabled = false;
  submitBtn.textContent = "上传";
});
</script>
{% endblock %}
