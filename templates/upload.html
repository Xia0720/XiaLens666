{% extends "base.html" %}
{% block title %}Upload Photos{% endblock %}
{% block content %}
<h2>Upload Photos</h2>

<form id="uploadForm" method="POST" enctype="multipart/form-data">
  <div>
    <label for="albumSelect">é€‰æ‹©ç›¸å†Œ</label><br>
    <select name="album" id="albumSelect" onchange="toggleNewAlbumInput()">
      {% for album in album_names %}
        {% if last_album %}
          <option value="{{ album }}" {% if last_album == album %}selected{% endif %}>{{ album }}</option>
        {% else %}
          <option value="{{ album }}">{{ album }}</option>
        {% endif %}
      {% endfor %}
      <option value="new" {% if last_album and last_album not in album_names %}selected{% endif %}>+ åˆ›å»ºæ–°ç›¸å†Œ</option>
    </select>
  </div>

  <div id="newAlbumDiv"
       style="display:{% if last_album and last_album not in album_names %}block{% else %}none{% endif %}; margin-top:10px;">
    <label for="new_album">æ–°ç›¸å†Œå</label><br>
    <input type="text" name="new_album" id="newAlbumInput"
           placeholder="è¾“å…¥æ–°ç›¸å†Œå"
           value="{% if last_album and last_album not in album_names %}{{ last_album }}{% endif %}">
  </div>

  <div style="margin-top:15px;">
    <label for="photo">é€‰æ‹©ç…§ç‰‡</label><br>
    <input type="file" name="photo" id="photo" multiple required>
  </div>

  <button id="submitBtn" type="submit" style="margin-top:15px;">ä¸Šä¼ </button>
</form>

<div id="uploadStatus" style="margin-top:15px; font-size:14px; color:#444;"></div>

<script src="https://cdn.jsdelivr.net/npm/exifreader@4/dist/exif-reader.min.js"></script>
<script>
/* ========== é…ç½®ï¼ˆåŠ¡å¿…æ›¿æ¢ä¸ºä½ çš„ preset / cloudï¼‰ ========== */
const CLOUD_NAME    = "dpr0pl2tf";       // â† ä½ çš„ Cloudinary cloud name
const UPLOAD_PRESET = "unsigned_preset"; // â† ä½ åˆ›å»ºçš„ unsigned preset å

// ğŸ‘‡ æ³¨å…¥åç«¯å˜é‡ï¼ˆå¯èƒ½æ˜¯ "albums" æˆ– ""ï¼‰
const MAIN_FOLDER = {{ (MAIN_ALBUM_FOLDER or "") | tojson }};

function toggleNewAlbumInput() {
  const select = document.getElementById('albumSelect');
  const newAlbumDiv = document.getElementById('newAlbumDiv');
  newAlbumDiv.style.display = (select && select.value === 'new') ? 'block' : 'none';
}
document.addEventListener('DOMContentLoaded', toggleNewAlbumInput);

document.getElementById('uploadForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const albumSelect = document.getElementById('albumSelect');
  const newAlbumInput = document.getElementById('newAlbumInput');
  const files = document.getElementById('photo').files;
  const statusDiv = document.getElementById('uploadStatus');
  const submitBtn = document.getElementById('submitBtn');

  let album = (albumSelect.value === 'new') ? (newAlbumInput.value || "").trim() : albumSelect.value;
  if (!album) { alert("è¯·å¡«å†™ç›¸å†Œåï¼"); return; }
  if (!files || files.length === 0) { alert("è¯·é€‰æ‹©ç…§ç‰‡ï¼"); return; }

  // âœ… æ”¹æˆç”±åç«¯æ§åˆ¶ï¼Œä¸å†å†™æ­» "albums"
  const folderPrefix = MAIN_FOLDER || "";
  const folderPath = folderPrefix ? `${folderPrefix}/${album}` : album;

  submitBtn.disabled = true;
  submitBtn.textContent = "æ­£åœ¨ä¸Šä¼ ...";
  statusDiv.innerHTML = "";

  const maxAttempts = 3;

  for (const file of Array.from(files)) {
    const item = document.createElement('div');
    item.textContent = `${file.name} - å‡†å¤‡ä¸Šä¼ ...`;
    statusDiv.appendChild(item);

    try {
      const url = await uploadWithRetries(file, folderPath, maxAttempts, item);
      await savePhotoToDB(album, url); // ä¿å­˜åˆ°åç«¯æ•°æ®åº“
      item.textContent = `${file.name} âœ… ä¸Šä¼ å¹¶ä¿å­˜æˆåŠŸ`;
      item.style.color = "green";
    } catch (err) {
      console.error(err);
      item.textContent = `${file.name} âŒ ä¸Šä¼ å¤±è´¥ï¼š${err && err.message ? err.message : err}`;
      item.style.color = "red";
    }
  }

  submitBtn.disabled = false;
  submitBtn.textContent = "ä¸Šä¼ ";
});

async function getTakenAtISO(file) {
  try {
    const buf = await file.arrayBuffer();
    const tags = ExifReader.load(buf, {expanded: true});
    // å¸¸è§å­—æ®µï¼šexif.DateTimeOriginal æˆ– exif.CreateDate
    const dt = (tags.exif && (tags.exif.DateTimeOriginal || tags.exif.CreateDate))
               ? (tags.exif.DateTimeOriginal.description || tags.exif.CreateDate.description)
               : null;
    if (dt) {
      // å½¢å¦‚ "2024:11:03 14:22:10" â†’ è½¬ ISO
      const iso = dt.replace(/^(\d{4}):(\d{2}):(\d{2})\s+/, '$1-$2-$3T') + 'Z';
      return iso;
    }
  } catch(e) { /* å¿½ç•¥ï¼Œèµ°å…œåº• */ }
  // å…œåº•ï¼šç”¨æ–‡ä»¶çš„ lastModified
  try {
    const d = new Date(file.lastModified);
    return d.toISOString();
  } catch(e) {
    return new Date().toISOString();
  }
}
  
async function uploadWithRetries(file, folder, maxAttempts, statusItem) {
  let attempt = 0;
  while (attempt < maxAttempts) {
    attempt++;
    try {
      statusItem.textContent = `${file.name} - ä¸Šä¼ ä¸­ï¼ˆç¬¬ ${attempt} æ¬¡ï¼‰...`;
      const url = await uploadToCloudinary(file, folder);
      return url;
    } catch (err) {
      console.warn(`ä¸Šä¼ ç¬¬ ${attempt} æ¬¡å¤±è´¥`, err);
      if (attempt >= maxAttempts) throw err;
      await new Promise(r => setTimeout(r, 500 * attempt));
    }
  }
}

async function uploadToCloudinary(file, folder) {
  const apiUrl = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", UPLOAD_PRESET);
  if (folder) fd.append("folder", folder);

  const res = await fetch(apiUrl, { method: "POST", body: fd });
  const data = await res.json();
  if (!res.ok) {
    const msg = (data && data.error && data.error.message) ? data.error.message : JSON.stringify(data);
    throw new Error(msg);
  }
  return data.secure_url;
}

async function savePhotoToDB(album, url) {
  const res = await fetch("/save_photo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album: album, url: url })
  });
  const data = await res.json();
  if (!res.ok || data.success === false) {
    throw new Error(data.error || "ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥");
  }
  return data;
}
</script>
{% endblock %}
