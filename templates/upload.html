{% extends "base.html" %}
{% block title %}Upload - XiaCapture{% endblock %}
{% block content %}
<h1>Upload</h1>

<!-- 新建相册表单 -->
<form method="POST" action="{{ url_for('upload') }}">
    <label for="album_name">新相册名称：</label>
    <input type="text" id="album_name" name="album_name" required>
    <button type="submit" name="action" value="create_album">创建新相册</button>
</form>

<hr>

<!-- 上传照片表单 -->
<form method="POST" enctype="multipart/form-data" action="{{ url_for('upload') }}">
    <label for="album">选择相册：</label>
    <select id="album" name="album" required>
        {% for album in albums %}
        <option value="{{ album.id }}">{{ album.name }}</option>
        {% endfor %}
    </select>
    <br><br>
    <input type="file" name="photos" multiple required>
    <br><br>
    <button type="submit" name="action" value="upload_photos">上传照片</button>
</form>

<div id="uploadStatus" style="margin-top:15px; font-size:14px; color:#444;"></div>

<script>
// === 控制是否显示“新相册输入框” ===
function toggleNewAlbumInput() {
    var select = document.getElementById('albumSelect');
    var newAlbumDiv = document.getElementById('newAlbumDiv');
    newAlbumDiv.style.display = (select.value === 'new') ? 'block' : 'none';
}

// 页面加载时执行一次，避免初始状态错误
window.onload = function() {
    toggleNewAlbumInput();
}

// === 批量并发上传到 Cloudinary（前端直传） ===
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const albumSelect = document.getElementById('albumSelect');
    const newAlbumInput = document.getElementById('newAlbumInput');
    const album = (albumSelect.value === 'new') ? newAlbumInput.value.trim() : albumSelect.value;
    const files = document.getElementById('photo').files;
    const statusDiv = document.getElementById('uploadStatus');

    if (!album) {
        alert("请填写相册名！");
        return;
    }
    if (files.length === 0) {
        alert("请选择照片！");
        return;
    }

    statusDiv.innerHTML = `开始上传到相册：<b>${album}</b> ...`;

    // === 批量上传 ===
    const chunkSize = 5;  // 每次上传 5 张，避免超时
    let uploaded = 0;

    for (let i = 0; i < files.length; i += chunkSize) {
        const chunk = Array.from(files).slice(i, i + chunkSize);
        await Promise.all(chunk.map(file => uploadToCloudinary(file, album)));

        uploaded += chunk.length;
        statusDiv.innerHTML = `已完成 ${uploaded}/${files.length} 张上传`;
    }

    statusDiv.innerHTML = `✅ 全部上传完成！相册：${album}`;
});

// === Cloudinary 上传函数 ===
// ⚠️ 你需要把 cloud_name 和 upload_preset 换成你自己的
async function uploadToCloudinary(file, album) {
    const url = "https://api.cloudinary.com/v1_1/<dpr0pl2tf>/upload";
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "<ml_default>");
    formData.append("folder", album); // 存到对应相册目录

    try {
        const res = await fetch(url, { method: "POST", body: formData });
        const data = await res.json();
        return data.secure_url;
    } catch (err) {
        console.error("上传失败：", err);
    }
}
</script>
{% endblock %}
