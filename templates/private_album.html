{% extends "base.html" %}
{% block title %}Private Space{% endblock %}

{% block content %}
<h1 style="text-align:center; margin-top:20px;">Private Space</h1>

<!-- 上传按钮 -->
<div style="text-align:center; margin:20px 0;">
  <button id="show-upload-btn" style="padding:8px 16px; cursor:pointer;">Upload Photos</button>
</div>

<!-- 上传表单，默认隐藏 -->
<div id="upload-area" style="display:none; max-width:600px; margin:0 auto; border:1px solid #ccc; padding:15px; border-radius:8px;">
  <form id="private-upload-form" enctype="multipart/form-data">
    <label>选择相册：
      <select name="album" id="album-select">
        {% for album in album_names %}
          <option value="{{ album }}" {% if album==last_album %}selected{% endif %}>{{ album }}</option>
        {% endfor %}
        <option value="new">+ New Album</option>
      </select>
    </label>
    <br><br>
    <div id="new-album-div" style="display:none;">
      新相册名（仅在选择新建时有效）：
      <input type="text" name="new_album" id="new-album-input" placeholder="New album name">
    </div>
    <br>
    <input type="file" name="photo" id="photo-input" multiple>
    <br><br>
    <button type="submit" style="padding:6px 12px;">Upload</button>
  </form>
  <div id="upload-status" style="margin-top:10px;"></div>
</div>

<hr style="margin:30px 0;">

<!-- 相册展示 -->
<div class="album-grid">
  {% for album in album_names %}
    <div class="album-item">
      <a href="{{ url_for('view_private_album', album_name=album) }}">
        <div class="album-cover">
          {% set cover = cloudinary.api.resources(type='upload', prefix='private/' ~ album, max_results=1).resources[0].secure_url if cloudinary.api.resources(type='upload', prefix='private/' ~ album, max_results=1).resources else '' %}
          {% if cover %}
            <img src="{{ cover }}" alt="{{ album }}">
          {% else %}
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#eee;color:#666;">No Photo</div>
          {% endif %}
        </div>
        <div class="album-name">{{ album }}</div>
      </a>
    </div>
  {% endfor %}
</div>

<style>
.album-grid {
  display:flex; flex-wrap: wrap; gap:15px; justify-content: center;
}
.album-item {
  width: 200px; text-align:center; cursor:pointer;
}
.album-cover {
  width:200px; height:200px; overflow:hidden; border-radius:8px;
}
.album-cover img {
  width:100%; height:100%; object-fit:cover;
}
.album-name {
  margin-top:5px; font-weight:bold;
}
</style>

<script>
document.getElementById("show-upload-btn").addEventListener("click", function(){
  const area = document.getElementById("upload-area");
  area.style.display = area.style.display === "none" ? "block" : "none";
});

// 显示/隐藏新建相册输入框
document.getElementById("album-select").addEventListener("change", function(){
  document.getElementById("new-album-div").style.display = this.value === "new" ? "block" : "none";
});

// 上传 Ajax
document.getElementById("private-upload-form").addEventListener("submit", function(e){
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const status = document.getElementById("upload-status");
  status.textContent = "Uploading...";

  fetch("{{ url_for('upload_private') }}", {
    method: "POST",
    body: data
  }).then(res=>res.json())
    .then(res=>{
      if(res.success){
        status.textContent = "Upload successful!";
        setTimeout(()=>location.reload(), 1000); // 上传成功刷新页面显示封面
      } else {
        status.textContent = "Error: " + res.error;
      }
    }).catch(err=>{
      status.textContent = "Upload failed: " + err;
    });
});
</script>
{% endblock %}
