{% extends "base.html" %}
{% block title %}Private Space{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<h1 style="text-align:center; margin-top:20px;">Private Space</h1>

<!-- 上传表单 -->
<form id="privateUploadForm" method="POST" enctype="multipart/form-data" style="margin: 20px auto; text-align:center;">
  <label for="album">选择相册：</label>
  <select name="album" id="album">
    <option value="new">新建相册</option>
    {% for album in album_names %}
      <option value="{{ album }}" {% if album == last_album %}selected{% endif %}>{{ album }}</option>
    {% endfor %}
  </select>
  <input type="text" name="new_album" placeholder="新相册名（仅在选择新建时有效）">

  <input type="file" name="photo" multiple>
  <button type="submit">上传</button>
</form>

<p id="upload-status" style="text-align:center; color:green;"></p>

<hr>

<!-- 已有照片展示 -->
<form method="POST" action="{{ url_for('delete_private_images') }}" onsubmit="return confirm('Are you sure to delete selected images?');">
  <div class="album-grid">
    {% for img in images %}
      <div class="album-item">
        <input type="checkbox" name="public_ids" value="{{ img.public_id }}">
        <a href="{{ img.secure_url }}" class="glightbox" data-gallery="private-album">
          <img src="{{ img.secure_url }}" alt="Photo">
        </a>
      </div>
    {% endfor %}
  </div>

  <div style="text-align: right; margin-top: 20px;">
    <button type="submit" style="padding: 5px 12px;">删除选中照片</button>
  </div>
</form>

<!-- 样式 -->
<style>
  .album-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
  }
  .album-item {
    position: relative;
    width: 200px;
    height: 200px;
    overflow: hidden;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: transform 0.2s;
  }
  .album-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .album-item:hover {
    transform: scale(1.03);
  }
  .album-item input[type="checkbox"] {
    position: absolute;
    top: 6px;
    left: 6px;
    z-index: 10;
    width: 20px;
    height: 20px;
  }
</style>

<!-- JS 上传逻辑 -->
<script>
  document.getElementById("privateUploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const status = document.getElementById("upload-status");
    status.style.color = "blue";
    status.textContent = "⏳ 上传中...";

    try {
      const response = await fetch("{{ url_for('upload_private') }}", {
        method: "POST",
        body: formData
      });
      const result = await response.json();

      if (result.success) {
        status.style.color = "green";
        status.textContent = "✅ 上传并保存成功！";
        setTimeout(() => location.reload(), 1500); // 1.5s 后刷新页面
      } else {
        status.style.color = "red";
        status.textContent = "❌ 上传失败: " + (result.error || "未知错误");
      }
    } catch (err) {
      status.style.color = "red";
      status.textContent = "❌ 请求出错: " + err.message;
    }
  });

  const lightbox = GLightbox({
    selector: '.glightbox',
    loop: true,
    touchNavigation: true,
    keyboardNavigation: true,
    closeOnOutsideClick: true
  });
</script>
{% endblock %}

