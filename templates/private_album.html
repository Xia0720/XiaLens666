{% extends "base.html" %}
{% block title %}Private Space{% endblock %}

{% block content %}
<h1 style="text-align:center; margin-top:20px;">Private Space</h1>

<!-- 上传按钮 -->
<div style="text-align:center; margin:20px 0;">
  <button id="show-upload-btn" style="padding:8px 16px; cursor:pointer;">Upload Photos</button>
</div>

<!-- 上传表单，默认隐藏 -->
<div id="upload-area" style="display:none; max-width:700px; margin:0 auto; border:1px solid #ccc; padding:15px; border-radius:8px;">
  <form id="uploadForm" method="POST" enctype="multipart/form-data">
    <div>
      <label for="albumSelect">选择相册</label><br>
      <select name="album" id="albumSelect" onchange="toggleNewAlbumInput()">
        {% for album in album_names %}
          {% if last_album %}
            <option value="{{ album }}" {% if last_album == album %}selected{% endif %}>{{ album }}</option>
          {% else %}
            <option value="{{ album }}">{{ album }}</option>
          {% endif %}
        {% endfor %}
        <option value="new" {% if last_album and last_album not in album_names %}selected{% endif %}>+ 创建新相册</option>
      </select>
    </div>

    <div id="newAlbumDiv"
         style="display:{% if last_album and last_album not in album_names %}block{% else %}none{% endif %}; margin-top:10px;">
      <label for="new_album">新相册名</label><br>
      <input type="text" name="new_album" id="newAlbumInput"
             placeholder="输入新相册名"
             value="{% if last_album and last_album not in album_names %}{{ last_album }}{% endif %}">
    </div>

    <div style="margin-top:15px;">
      <label for="photoInput">选择照片</label><br>
      <input type="file" name="photo" id="photoInput" multiple required>
    </div>

    <button id="submitBtn" type="submit" style="margin-top:15px; padding:8px 14px;">上传</button>
  </form>

  <div id="uploadStatus" style="margin-top:15px; font-size:14px; color:#444;"></div>
</div>

<hr style="margin:30px 0;">

<!-- 相册展示 -->
<div class="album-grid">
  {% for album in album_names %}
    <div class="album-item">
      <a href="{{ url_for('view_private_album', album_name=album) }}">
        <div class="album-cover">
          {% if album_covers.get(album) %}
            <img src="{{ album_covers[album] }}" alt="{{ album }}">
          {% else %}
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#eee;color:#666;">No Photo</div>
          {% endif %}
        </div>
        <div class="album-name">{{ album }}</div>
      </a>
    </div>
  {% endfor %}
</div>

<style>
.album-grid {
  display:flex; flex-wrap: wrap; gap:15px; justify-content: center;
}
.album-item {
  width: 200px; text-align:center; cursor:pointer;
}
.album-cover {
  width:200px; height:200px; overflow:hidden; border-radius:8px;
}
.album-cover img {
  width:100%; height:100%; object-fit:cover;
}
.album-name {
  margin-top:5px; font-weight:bold;
}
</style>

<!-- ExifReader (同 upload.html 使用的库) -->
<script src="https://cdn.jsdelivr.net/npm/exifreader@4/dist/exif-reader.min.js"></script>

<script>
/*
  与 upload.html 一致的前端上传逻辑（上传到 Cloudinary unsigned，然后调用后端保存记录）
  - 请确保后端存在 /save_photo 路由来接收 { album, url } JSON 并写入数据库
*/

const CLOUD_NAME    = "dpr0pl2tf";       // Cloudinary cloud name（与你 site 一致）
const UPLOAD_PRESET = "unsigned_preset"; // 你的 unsigned preset（与你 upload.html 一致）
const MAIN_FOLDER   = "private";         // private 上传的主文件夹（与后端 upload_private 的 folder 一致）
const MAX_SIZE      = 10 * 1024 * 1024;  // 10MB
const MAX_ATTEMPTS  = 3;
const SAVE_PHOTO_ENDPOINT = "/save_photo"; // 与 upload.html 一致的保存记录端点

// 显示/隐藏上传区域
document.getElementById("show-upload-btn").addEventListener("click", () => {
  const area = document.getElementById("upload-area");
  area.style.display = (area.style.display === "none" || area.style.display === "") ? "block" : "none";
  if (area.style.display === "block") area.scrollIntoView({behavior:"smooth", block:"center"});
});

// 新相册输入框切换
function toggleNewAlbumInput() {
  const select = document.getElementById('albumSelect');
  const newAlbumDiv = document.getElementById('newAlbumDiv');
  newAlbumDiv.style.display = (select && select.value === 'new') ? 'block' : 'none';
}
document.addEventListener('DOMContentLoaded', () => {
  toggleNewAlbumInput();
});

// 表单提交逻辑（和 upload.html 一致）
document.getElementById('uploadForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const albumSelect = document.getElementById('albumSelect');
  const newAlbumInput = document.getElementById('newAlbumInput');
  const files = document.getElementById('photoInput').files;
  const statusDiv = document.getElementById('uploadStatus');
  const submitBtn = document.getElementById('submitBtn');

  let album = (albumSelect.value === 'new') ? (newAlbumInput.value || "").trim() : albumSelect.value;
  if (!album) { alert("请填写相册名！"); return; }
  if (!files || files.length === 0) { alert("请选择照片！"); return; }

  const folderPath = MAIN_FOLDER ? `${MAIN_FOLDER}/${album}` : album;

  submitBtn.disabled = true;
  submitBtn.textContent = "正在上传...";
  statusDiv.innerHTML = "";

  for (const file of Array.from(files)) {
    const item = document.createElement('div');
    item.textContent = `${file.name} - 准备上传...`;
    statusDiv.appendChild(item);

    try {
      const url = await uploadWithRetries(file, folderPath, MAX_ATTEMPTS, item);
      await savePhotoToDB(album, url);
      item.textContent = `${file.name} ✅ 上传并保存成功`;
      item.style.color = "green";
    } catch (err) {
      console.error(err);
      item.textContent = `${file.name} ❌ 上传失败：${err && err.message ? err.message : err}`;
      item.style.color = "red";
    }
  }

  submitBtn.disabled = false;
  submitBtn.textContent = "上传";
});

// ====== 工具函数：读取拍摄时间（尝试 EXIF） ======
async function getTakenAtISO(file) {
  try {
    const buf = await file.arrayBuffer();
    const tags = ExifReader.load(buf, {expanded: true});
    const dt = (tags.exif && (tags.exif.DateTimeOriginal || tags.exif.CreateDate))
               ? (tags.exif.DateTimeOriginal.description || tags.exif.CreateDate.description)
               : null;
    if (dt) {
      const iso = dt.replace(/^(\d{4}):(\d{2}):(\d{2})\s+/, '$1-$2-$3T') + 'Z';
      return iso;
    }
  } catch(e) {}
  try { return new Date(file.lastModified).toISOString(); } catch(e) { return new Date().toISOString(); }
}

// ====== 上传带重试 ======
async function uploadWithRetries(file, folder, maxAttempts, statusItem) {
  let attempt = 0;
  while (attempt < maxAttempts) {
    attempt++;
    try {
      statusItem.textContent = `${file.name} - 上传中（第 ${attempt} 次）...`;
      const url = await uploadToCloudinary(file, folder);
      return url;
    } catch (err) {
      console.warn(`上传第 ${attempt} 次失败`, err);
      if (attempt >= maxAttempts) throw err;
      await new Promise(r => setTimeout(r, 500 * attempt));
    }
  }
}

// ====== 上传到 Cloudinary（含大文件压缩 + public_id 安全化 + context taken_at） ======
async function uploadToCloudinary(file, folder) {
  let uploadFile = file;

  // 超过 MAX_SIZE 前端压缩（图片）
  if (file.size > MAX_SIZE) {
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    let width = img.width;
    let height = img.height;

    const maxDim = 3000;
    if (width > height && width > maxDim) {
      height = Math.round(height * maxDim / width);
      width = maxDim;
    } else if (height > width && height > maxDim) {
      width = Math.round(width * maxDim / height);
      height = maxDim;
    } else if (width === height && width > maxDim) {
      width = maxDim;
      height = maxDim;
    }

    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    uploadFile = await new Promise(resolve => 
      canvas.toBlob(resolve, "image/jpeg", 0.9)
    );
  }

  const takenAt = await getTakenAtISO(file);
  const apiUrl = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
  const fd = new FormData();
  fd.append("file", uploadFile);
  fd.append("upload_preset", UPLOAD_PRESET);
  if (folder) fd.append("folder", folder);

  // public_id 用文件名（去掉扩展），并做简单安全化
  const baseName = file.name.split('.').slice(0, -1).join('.') || Date.now().toString();
  const safePublicId = baseName.replace(/[^a-zA-Z0-9_-]/g,'_').slice(0, 200);
  fd.append("public_id", safePublicId);
  fd.append("context", `taken_at=${takenAt}`);

  const res = await fetch(apiUrl, { method: "POST", body: fd });
  const data = await res.json();
  if (!res.ok) {
    const msg = (data && data.error && data.error.message) ? data.error.message : JSON.stringify(data);
    throw new Error(msg);
  }
  return data.secure_url;
}

// ====== 保存到后端数据库（与 upload.html 一致） ======
async function savePhotoToDB(album, url) {
  const res = await fetch(SAVE_PHOTO_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ album: album, url: url })
  });
  const data = await res.json();
  if (!res.ok || data.success === false) {
    throw new Error(data.error || "保存到数据库失败");
  }
  return data;
}
</script>
{% endblock %}
